<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Justice-Bot</title>
  <meta name="description" content="Supabase auth + same-origin API via Cloudflare Worker proxy." />
  <link rel="icon" href="/favicon.ico" />
  <!-- Lightweight, nice defaults -->
  <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@2.0.6/css/pico.min.css">
  <style>
    :root { --brand:#0a6cff; }
    header { margin: 1rem 0 0.5rem }
    .brand { color: var(--brand); font-weight: 700; }
    .grid { gap: 1rem }
    pre { background:#0f172a0d; padding: 12px; border-radius: 8px; }
    .muted { color:#64748b; font-size: .9rem }
  </style>
</head>
<body>
  <main class="container">
    <header>
      <h1 class="brand">Justice-Bot</h1>
      <p class="muted">Static frontend → Cloudflare Worker → Railway API. Sign in with Supabase and call <code>/api</code> with your Bearer token.</p>
    </header>

    <article>
      <h3>Environment (from <code>/config.json</code>)</h3>
      <div>SUPABASE_URL: <strong id="cfg-url" class="muted">(loading)</strong></div>
      <div>API_BASE_URL: <strong id="cfg-api" class="muted">(loading)</strong></div>
    </article>

    <div class="grid">
      <article>
        <h3>Auth</h3>
        <label>Email <input id="email" type="email" placeholder="you@example.com" required></label>
        <label>Password <input id="password" type="password" placeholder="••••••••" required></label>
        <div>
          <button id="signup">Sign Up</button>
          <button id="signin" class="secondary">Sign In</button>
          <button id="signout" class="contrast">Sign Out</button>
          <button id="reset" style="float:right">Reset Password</button>
        </div>
        <details>
          <summary>Session</summary>
          <pre id="authlog">(no session)</pre>
        </details>
      </article>

      <article>
        <h3>API Tests</h3>
        <div>
          <button id="ping">GET /api/health</button>
          <button id="whoami" class="secondary">GET /api/whoami (needs login)</button>
        </div>
        <details open>
          <summary>Response</summary>
          <pre id="apilog">(no calls yet)</pre>
        </details>
      </article>
    </div>

    <p class="muted">Tip: if anything looks stale, hard-refresh (Cmd/Ctrl+Shift+R) — Pages can cache.</p>
  </main>

  <script type="module">
    (async () => {
      // 1) Load public config (never put secrets here)
      const cfg = await fetch('/config.json', { cache: 'no-cache' }).then(r => r.json());
      const $ = sel => document.querySelector(sel);
      $('#cfg-url').textContent = cfg.SUPABASE_URL ?? '(missing)';
      $('#cfg-api').textContent = cfg.API_BASE_URL ?? '(missing)';

      // 2) Supabase client via ESM (no bundler)
      const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm');
      const supabase = createClient(cfg.SUPABASE_URL, cfg.SUPABASE_ANON_KEY, {
        auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
      });

      const logAuth = (x) => $('#authlog').textContent = typeof x === 'string' ? x : JSON.stringify(x, null, 2);
      const logApi  = (x) =>  $('#apilog').textContent  = typeof x === 'string' ? x : JSON.stringify(x, null, 2);

      // 3) Keep UI in sync with auth state
      supabase.auth.onAuthStateChange(async (_event, session) => {
        logAuth(session ?? '(no session)');
      });

      // 4) Auth buttons
      $('#signup').onclick = async () => {
        const { data, error } = await supabase.auth.signUp({
          email: $('#email').value, password: $('#password').value
        });
        logAuth(error ?? data);
      };

      $('#signin').onclick = async () => {
        const { data, error } = await supabase.auth.signInWithPassword({
          email: $('#email').value, password: $('#password').value
        });
        logAuth(error ?? data);
      };

      $('#signout').onclick = async () => {
        const { error } = await supabase.auth.signOut();
        logAuth(error ?? '(signed out)');
      };

      $('#reset').onclick = async () => {
        const url = location.origin; // send reset link back to this site
        const { data, error } = await supabase.auth.resetPasswordForEmail($('#email').value, { redirectTo: url });
        logAuth(error ?? data);
      };

      // 5) Helper to call your API through the Worker
      async function callApi(path, opts = {}) {
        const token = (await supabase.auth.getSession()).data.session?.access_token;
        const headers = new Headers(opts.headers || {});
        if (token) headers.set('Authorization', `Bearer ${token}`);
        const res = await fetch(`${cfg.API_BASE_URL}${path}`, { ...opts, headers });
        const text = await res.text();
        let body; try { body = JSON.parse(text) } catch { body = text }
        return { status: res.status, body };
      }

      $('#ping').onclick = async () => {
        try { logApi(await callApi('/health')); } catch (e) { logApi(String(e)) }
      };
      $('#whoami').onclick = async () => {
        try { logApi(await callApi('/whoami')); } catch (e) { logApi(String(e)) }
      };

      // Show current session on load
      logAuth(await supabase.auth.getSession());
    })();
  </script>
</body>
</html>
