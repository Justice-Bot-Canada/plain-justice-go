<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Justice-Bot – Dev Console</title>
  <link rel="icon" href="/favicon.ico">
  <style>
    :root { --panel:#0f172a; --muted:#94a3b8; --text:#e2e8f0; --brand:#3b82f6; }
    *{box-sizing:border-box} body{margin:0;background:#0b1220;color:var(--text);font:15px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:1100px;margin:0 auto;padding:24px}
    h1{margin:0 0 8px} .muted{color:var(--muted)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:18px}
    .panel{background:var(--panel);border:1px solid #1f2937;border-radius:14px;padding:16px}
    input,button{font:inherit}
    input{width:100%;padding:10px;border-radius:10px;border:1px solid #26344d;background:#0e1627;color:var(--text)}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    button{padding:10px 12px;border-radius:10px;border:1px solid #26344d;background:#0e1627;color:#fff;cursor:pointer}
    button.primary{background:var(--brand);border:none}
    pre{background:#0e1627;border:1px solid #26344d;border-radius:10px;padding:12px;white-space:pre-wrap;max-height:320px;overflow:auto}
    .pill{font-size:12px;color:var(--muted)}
    a{color:#93c5fd}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Justice-Bot <span class="pill">Dev Console</span></h1>
    <p class="muted">Reads <code>/frontend/config.json</code>, signs in with Supabase, and calls your API via the Cloudflare Worker proxy at <code>/api/*</code>.</p>

    <div class="panel" style="margin:16px 0">
      <strong>Environment (from <code>config.json</code>)</strong>
      <div id="env">Loading…</div>
    </div>

    <div class="grid">
      <div class="panel">
        <h3>Auth</h3>
        <div class="row"><input id="email" placeholder="you@example.com"></div>
        <div class="row" style="margin-top:8px"><input id="password" type="password" placeholder="password"></div>
        <div class="row" style="margin-top:10px">
          <button id="btnSignUp" class="primary">Sign Up</button>
          <button id="btnSignIn">Sign In</button>
          <button id="btnSignOut">Sign Out</button>
          <button id="btnShowSession">Show Session</button>
        </div>
        <div id="log" class="muted" style="margin-top:10px">(no messages yet)</div>
        <h4 style="margin:10px 0 6px">Session</h4>
        <pre id="session">(no session)</pre>
      </div>

      <div class="panel">
        <h3>API Tests</h3>
        <div class="row">
          <button id="btnGetHealth" class="primary">GET /api/health</button>
          <button id="btnGetWhoami">GET /api/whoami (needs login)</button>
          <button id="btnGetEnt">GET /api/entitlements</button>
        </div>
        <h4 style="margin:10px 0 6px">Response</h4>
        <pre id="apiResponse">(no calls yet)</pre>
      </div>
    </div>

    <p class="muted" style="margin-top:16px">
      Back to marketing home: <a href="/">/</a>
    </p>
  </div>

  <!-- All logic in one module for simplicity -->
  <script type="module">
    const el = (id)=>document.getElementById(id);
    const set = (id, v)=>el(id).textContent = typeof v==='string'?v:JSON.stringify(v,null,2);

    // 1) Load public config
    const cfg = await fetch('/config.json', {cache:'no-cache'}).then(r=>r.json()).catch(()=>({}));
    const SUPABASE_URL = cfg.SUPABASE_URL;
    const ANON_KEY     = cfg.SUPABASE_ANON_KEY;
    const API_BASE     = cfg.API_BASE_URL || '/api';
    el('env').innerHTML =
      `SUPABASE_URL: <code>${SUPABASE_URL||'(missing)'}</code><br>`+
      `API_BASE_URL: <code>${API_BASE}</code><br>`+
      `PAYPAL_CLIENT_ID: <code>${cfg.PAYPAL_CLIENT_ID ? '(set)' : '(missing)'}</code>`;

    // 2) Supabase client
    const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm');
    const supabase = createClient(SUPABASE_URL, ANON_KEY, {
      auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
    });

    // helpers
    const showSession = async () => set('session', (await supabase.auth.getSession()).data.session ?? '(no session)');
    supabase.auth.onAuthStateChange(() => showSession());
    showSession();

    const log = (m)=> set('log', m);

    // 3) Auth buttons
    el('btnSignUp').onclick = async () => {
      const { data, error } = await supabase.auth.signUp({
        email: el('email').value, password: el('password').value
      });
      log(error ?? 'Sign-up email sent (check inbox)');
      showSession();
    };
    el('btnSignIn').onclick = async () => {
      const { data, error } = await supabase.auth.signInWithPassword({
        email: el('email').value, password: el('password').value
      });
      log(error ?? 'Signed in');
      showSession();
    };
    el('btnSignOut').onclick = async () => {
      const { error } = await supabase.auth.signOut();
      log(error ?? 'Signed out');
      showSession();
    };
    el('btnShowSession').onclick = showSession;

    // 4) API helper (adds Bearer if logged in)
    async function callApi(path, { method='GET', body, headers } = {}) {
      const token = (await supabase.auth.getSession()).data.session?.access_token;
      const h = new Headers(headers || {});
      if (token) h.set('Authorization', `Bearer ${token}`);
      if (body && !h.has('Content-Type')) h.set('Content-Type', 'application/json');
      const res = await fetch(`${API_BASE}${path}`, { method, headers:h, body: body?JSON.stringify(body):undefined });
      const text = await res.text();
      let data; try { data = JSON.parse(text) } catch { data = text }
      return { status: res.status, body: data };
    }

    // 5) Buttons
    el('btnGetHealth').onclick = async ()=> set('apiResponse', await callApi('/health'));
    el('btnGetWhoami').onclick = async ()=> set('apiResponse', await callApi('/whoami'));
    el('btnGetEnt').onclick   = async ()=> set('apiResponse', await callApi('/entitlements'));
  </script>
</body>
</html>
